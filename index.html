<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBS Alert - Remote & Custom CSS</title>
    <style>
        /* --- CSS DARI USER --- */
        @import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700;800&display=swap');

        .alert {
            font-family: 'Open Sans', sans-serif !important;
            font-weight: 800;
            text-align: center;
            padding-top: 10px;
            text-shadow: 0 0 1px #000, 0 0 2px #000, 0 0 3px #000, 0 0 4px #000, 0 0 5px #000;
            
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
            opacity: 0; 
            /* Transition dihapus (no fade anim) */
        }

        .media {
            height: 100%;
            width: 100%;
            border-radius: 10px;
            margin-bottom: 14px;
            display: block; 
            object-fit: cover; 
        }

        .template {
            font-size: 1.7rem !important;
            margin: 5px 0;
        }

        .wiggle {
            color: #0f0 !important;
            display: inline-block;
            animation: .5s infinite wiggle;
        }

        .from {
            color: #eee !important;
        }

        .message {
            line-height: 1.5;
            padding: 10px;
            font-weight: bolder !important;
            color: #ff0 !important;
            opacity: 1;
            font-size: 1.51rem !important;
            margin-top: 5px;
        }

        @keyframes wiggle {
            0%, 100%, 80% { transform: rotate(0); }
            85% { transform: rotate(5deg); }
            95% { transform: rotate(-5deg); }
        }

        /* --- LAYOUT & KONTROL --- */
        html, body {
            margin: 0;
            padding: 0;
            background-color: transparent;
            font-family: 'Open Sans', sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            height: 100vh;
        }

        #test-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%; 
            background: transparent;
            padding: 15px 20px;
            z-index: 999;
            display: flex;
            flex-direction: row; 
            align-items: center;
            gap: 15px;
            box-sizing: border-box;
        }

        .input-group {
            display: flex;
            flex-direction: row;
            gap: 10px;
            flex-grow: 1; 
            flex-wrap: wrap;
        }

        input[type="text"] {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #555;
            background: rgba(34, 34, 34, 0.9);
            color: #fff;
            flex: 1; 
            min-width: 100px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-shrink: 0; 
        }
        
        button {
            background: #0f0;
            border: none;
            padding: 10px 20px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            color: #000;
            font-size: 14px;
            white-space: nowrap;
        }
        
        button.manual-btn {
            background: #00d2ff;
        }

        button.bg-btn {
            background: #ff00ff; /* Magenta */
            color: white;
        }

        button:hover {
            opacity: 0.8;
        }

        .img-placeholder {
            width: 100%;
            height: 200px;
            background: #333;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            margin-bottom: 14px;
        }

        /* Indikator Status Koneksi */
        #status-indicator {
            position: fixed;
            bottom: 5px;
            right: 5px;
            font-size: 10px;
            color: #aaa;
            z-index: 1000;
        }
    </style>
</head>
<body>

    <div id="alert-box" class="alert">
        <img src="thanks.gif" class="media" id="alert-media" onerror="this.style.display='none'; document.getElementById('media-fallback').style.display='flex'">
        <div id="media-fallback" class="img-placeholder" style="display: none;">thanks.gif missing</div>

        <p class="template">
            <span class="wiggle" id="amount-text">Rp 0</span> 
            <span class="from">dari</span> 
            <span class="wiggle" id="supporter-name">User</span>
        </p>
        <p class="message" id="message-text">Pesan...</p>
    </div>

    <!-- PANEL KONTROL -->
    <div id="test-controls">
        <div class="input-group">
            <input type="text" id="input-name" placeholder="Nama" value="Penonton Setia">
            <input type="text" id="input-amount" placeholder="Nominal" value="IDR 10,000">
            <input type="text" id="input-image" placeholder="URL Gambar (Kosong = thanks.gif)" value="">
            <input type="text" id="input-message" placeholder="Pesan..." value="Halo bang, request lagu dong!">
        </div>
        <div class="btn-group">
            <button class="manual-btn" id="btn-kirim">Kirim</button>
            <button id="btn-acak">Acak</button>
            <button class="bg-btn" onclick="toggleBackground()">Ganti BG</button>
        </div>
    </div>
    
    <div id="status-indicator">Connecting...</div>

    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURASI FIREBASE ---
        // Mencoba mengambil config dari environment variable
        let db, auth, appId;
        const statusDiv = document.getElementById('status-indicator');

        try {
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            // Login Anonymously
            signInAnonymously(auth).catch(console.error);
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    statusDiv.innerText = "Connected: " + user.uid.substring(0,5);
                    setupListener(user);
                } else {
                    statusDiv.innerText = "Disconnected";
                }
            });

        } catch (e) {
            console.error("Firebase Config Error:", e);
            statusDiv.innerText = "Offline Mode (Local Only)";
            // Fallback untuk mode offline murni jika perlu, tapi fitur remote akan mati
        }

        // --- LOGIKA ALERT (LOKAL) ---
        let hideTimeout = null; 
        let voices = [];
        let indoVoice = null;
        let lastProcessedTime = Date.now(); // Untuk mencegah alert lama muncul saat reload

        // Setup Suara
        function loadVoices() {
            voices = window.speechSynthesis.getVoices();
            indoVoice = voices.find(voice => voice.name.includes('Google Bahasa Indonesia')) || 
                        voices.find(voice => voice.name.includes('Microsoft Gadis')) ||
                        voices.find(voice => voice.lang === 'id-ID');
        }
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }

        function toggleBackground() {
            const currentBg = document.body.style.backgroundColor;
            if (currentBg === "" || currentBg === "transparent" || currentBg === "rgba(0, 0, 0, 0)") {
                document.body.style.backgroundColor = "#ff00ff"; // Magenta
            } else {
                document.body.style.backgroundColor = "transparent"; 
            }
        }

        function cleanTextForSpeech(text) {
            let clean = text;
            clean = clean.replace(/IDR\s*/gi, '');
            clean = clean.replace(/Rp\.?\s*/gi, '');
            clean = clean.replace(/\$/g, ''); 
            clean = clean.replace(/,/g, ''); 
            clean = clean.replace(/Stars/gi, 'Bintang');
            return clean;
        }

        function speakText(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            if (indoVoice) utterance.voice = indoVoice;
            utterance.lang = 'id-ID'; 
            utterance.rate = 1.0;     
            window.speechSynthesis.speak(utterance);
        }

        // Fungsi Menampilkan Alert di Layar (Visual & Audio)
        function doShowAlert(name, amount, message, imageUrl) {
            const alertBox = document.getElementById('alert-box');
            const mediaElement = document.getElementById('alert-media');
            const mediaFallback = document.getElementById('media-fallback');

            // Handle Gambar
            if (imageUrl && imageUrl.trim() !== "") {
                mediaElement.src = imageUrl;
            } else {
                mediaElement.src = "thanks.gif";
            }
            mediaElement.style.display = 'block';
            mediaFallback.style.display = 'none';

            // Handle Teks
            document.getElementById('amount-text').innerText = amount;
            document.getElementById('supporter-name').innerText = name;
            document.getElementById('message-text').innerText = message;

            // Tampilkan (No Fade)
            alertBox.style.opacity = '1';
            
            // Timer Reset
            if (hideTimeout) clearTimeout(hideTimeout);
            hideTimeout = setTimeout(() => {
                alertBox.style.opacity = '0';
            }, 12000); 

            // Audio TTS
            const spokenAmount = cleanTextForSpeech(amount);
            const textToRead = `${spokenAmount} dari ${name}. ${message}`;
            setTimeout(() => {
                speakText(textToRead);
            }, 200);
        }

        // --- LOGIKA DATABASE (REMOTE) ---

        // 1. MENDENGARKAN DATA (Receiver)
        function setupListener(user) {
            if (!db) return;
            
            // Gunakan collection 'public' agar bisa dishare antar device tanpa login spesifik
            const alertsRef = collection(db, 'artifacts', appId, 'public', 'data', 'obs_alerts');

            onSnapshot(alertsRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const data = change.doc.data();
                        
                        // Filter: Hanya tampilkan data yang baru dibuat (kurang dari 10 detik yang lalu)
                        // Ini penting agar saat OBS direfresh, alert lama tidak muncul semua
                        if (data.timestamp && data.timestamp > Date.now() - 10000) {
                            console.log("Alert baru diterima dari Database:", data);
                            doShowAlert(data.name, data.amount, data.message, data.image);
                        }
                    }
                });
            }, (error) => {
                console.error("Error listening to alerts:", error);
            });
        }

        // 2. MENGIRIM DATA (Sender)
        async function sendAlertToDB(name, amount, message, image) {
            if (!db || !auth.currentUser) {
                // Jika offline/error config, fallback ke lokal
                console.warn("Database tidak siap, menjalankan alert lokal.");
                doShowAlert(name, amount, message, image);
                return;
            }

            try {
                const alertsRef = collection(db, 'artifacts', appId, 'public', 'data', 'obs_alerts');
                await addDoc(alertsRef, {
                    name: name,
                    amount: amount,
                    message: message,
                    image: image,
                    timestamp: Date.now() // Waktu klien saat ini
                });
                console.log("Alert dikirim ke Database!");
            } catch (e) {
                console.error("Gagal mengirim alert:", e);
                alert("Gagal mengirim ke remote: " + e.message);
            }
        }

        // --- EVENT HANDLERS TOMBOL ---

        document.getElementById('btn-kirim').onclick = () => {
            const name = document.getElementById('input-name').value || "Anonim";
            const amount = document.getElementById('input-amount').value || "Rp 0";
            const message = document.getElementById('input-message').value || "Tes alert.";
            const image = document.getElementById('input-image').value; 
            
            // Kirim ke DB (ini akan trigger doShowAlert via listener juga)
            sendAlertToDB(name, amount, message, image);
        };

        document.getElementById('btn-acak').onclick = () => {
            const names = ["Sultan_Gabut", "Anak_Kos", "FansBerat01", "Kang_Bakso", "User123"];
            const amounts = ["IDR 10,000", "Rp 50.000", "1000 Stars", "Rp 5.000", "$5.00"];
            const messages = ["Semangat terus!", "Request lagu.", "GGWP!", "Sapa aku dong!", "Buat kopi."];
            const randomImages = [
                "https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExbDVqZm54bmI4ZnV4bmI4ZnV4bmI4ZnV4bmI4ZnV4bmI4ZnV4bmI4ZiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/Is1O1TWV0LEJi/giphy.gif",
                "https://media3.giphy.com/media/l0ExhcMvt7ZRzpibK/giphy.gif",
                "https://media.tenor.com/E1v8Xk1XNl4AAAAM/dancing-cat.gif"
            ];

            const rName = names[Math.floor(Math.random() * names.length)];
            const rAmount = amounts[Math.floor(Math.random() * amounts.length)];
            const rMsg = messages[Math.floor(Math.random() * messages.length)];
            const rImg = Math.random() > 0.5 ? randomImages[Math.floor(Math.random() * randomImages.length)] : "";

            sendAlertToDB(rName, rAmount, rMsg, rImg);
        };

        // Init
        window.onload = function() {
            loadVoices();
        }
    </script>
</body>
</html>
